# 内存控制

## V8的对象分配

​		在V8中，所有的JavaScript对象都是通过堆来进行分配的。Node提供了V8中内存使用量的查看方式，执行下面的代码：

```sh
$ node
process.memoryUsage()
{
  rss: 25747456,
  heapTotal: 5308416,
  heapUsed: 3053016,
  external: 1684953,
  arrayBuffers: 59062
}
```

​		其中heapTotal与heapUsed即是V8的堆内存使用情况，前者是已申请到的堆内存，后者是当前使用的量。

​		V8为何要限制堆的大小？表层原因为V8最初为浏览器而设计，不太可能遇到用大量内存的情况。深层原因是V8的垃圾回收机制的限制。按照官方的说法，以1.5GB的垃圾回收堆内存为例，V8做一次小的垃圾回收需要50ms，做一次非增量式的垃圾回收甚至需要1秒以上。这是垃圾回收中引起JavaScript线程暂停执行的时间，在这样的时间花销下，应用的性能和响应能力都会直线下降。这样的情况不仅仅后端服务无法接受，前端浏览器也无法接受。因此在当时的考虑下直接限制堆内存是一个好选择。

